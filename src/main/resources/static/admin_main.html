<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>管理员主页</title>
    <link rel="stylesheet" href="./css/foundation.min.css">
    <script src="js/vendor/jquery.js"></script>
    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/app.css">

    <script>
        $(document).ready(function() {
            $(document).foundation();
        });
    </script>

    <script>
        var currentLevel;
        var lastLevel;
        $(document).ready(function() {
            findAllLevel();
        });

        function findAllLevel(){
            $.ajax({
                url: "/level/findAllLevel",
                dataType: "text",
                success: function (result) {
                   var levelList = $.parseJSON(result);
                   loadAllLevel(levelList);
                },
                error: function (e) {
                    alert("错误")
                }
            });
        }
        function loadAllLevel(levelList){
            $("#content").empty();
            for(var i = 0;i<levelList.length;i++){
                var level = levelList[i];
                lastLevel = level;

                var grade = level.grade;
                var experienceNeed = level.experienceNeed;
                var description = level.description;
                var rate = level.rate;


                var div1 = document.createElement("div");
                $(div1).addClass("cell small-12 medium-4 large-3 padding_vertical");
                var div2 = document.createElement("div");
                $(div2).addClass("grid-padding-x content_center").css({"box-shadow": "10px 10px 5px #888888","width":"150px","border-radius": "5px"});
                var div3_1 = document.createElement("div");
                $(div3_1).addClass("large-12 medium-12 ").css({"overflow":"hidden","background-color":"#3adb76", "height":"100px"});
                var span = document.createElement("span");
                $(span).css("padding: 0px auto");
                $(span).text("关卡"+grade);
                $(div3_1).append(span);
                var div3_2 = document.createElement("div");
                $(div3_2).addClass("large-12 medium-12 ").css({"overflow": "hidden", "height": "50px"});
                $(div3_2).text(description);
                div2.append(div3_1);
                div2.append(div3_2);
                div1.append(div2);

                $(div2).click({"level":level},showLevelInfo);
                $("#content").append(div1);

            }
        }



        function addLevel(){

            var grade = $("#grade").val();
            var experience_need = $("#experience_need").val();
            var description = $("#description").val();
            var rate = $("#rate").val();



            var r = /^\+?[1-9][0-9]*$/;　　//正整数正则

            if(grade=="" || experience_need == "" || description == "" || rate == ""){
                $("#level_message").text("请输入完整").css({color:"red"});
                return false;
            }
            if(! r.test(experience_need)){
                $("#level_message").text("所需经验应为整数").css({color:"red"});
                return false;
            }
            if(experience_need <= lastLevel.experienceNeed){
                $("#level_message").text("所需经验应大于"+lastLevel.experienceNeed).css({color:"red"});
                return false;
            }


            if(! r.test(rate)){
                $("#level_message").text("通过率应为整数").css({color:"red"});
                return false;
            }
            if(rate <= 0 || rate > 100){
                $("#level_message").text("通过率应在0到100之间").css({color:"red"});
                return false;
            }
            var level = new Object();
            level.grade = grade;
            level.experienceNeed = experience_need;
            level.description = description;
            level.rate = rate;

            var levelStr = JSON.stringify(level);

            $.ajax({
                url: "/level/addLevel",
                dataType: "text",
                type: "post",
                data: {"level":levelStr},
                success: function (result) {
                    if(result == "true"){
                        //关闭当前
                        closeAddLevelPanel();
                        findAllLevel();
                    }
                },
                error: function (e) {
                    alert("错误")
                }
            });
        }





        function addQuestion(){



            var question_description = $("#question_description").val().trim();
            var test_point = $("#test_point").val().trim();
            var choice_a = $("#choice_a").val().trim();
            var choice_b = $("#choice_b").val().trim();
            var choice_c = $("#choice_c").val().trim();
            var choice_d = $("#choice_d").val().trim();
            var choice_e = $("#choice_e").val().trim();
            var correct_option = $("#correct_option").val().trim();
            var answer_analysis = $("#answer_analysis").val().trim();
            var experience_value = $("#experience_value").val().trim();
            var lNo = currentLevel.lNo;

            if(question_description == "" || choice_a == "" || choice_b == "" || correct_option == "" || experience_value == ""){
                $("#question_message").text("请输入完整").css({color:"red"});
                return false;
            }

            var arr = new Array();
            if(choice_a.trim() != "") arr.push("A")
            if(choice_b.trim() != "") arr.push("B")
            if(choice_c.trim() != "") arr.push("C")
            if(choice_d.trim() != "") arr.push("D")
            if(choice_e.trim() != "") arr.push("E")
            var isCorrect = false;
            var message_choice = ""
            for(var i = 0;i<arr.length;i++){
                if(correct_option.trim() == arr[i]){
                    isCorrect = true;
                }
                message_choice += arr[i];
                if(i != arr.length-1) message_choice += ",";
            }
            if(!isCorrect){
                $("#question_message").text("正确选项请输入："+message_choice).css({color:"red"});
                return false;
            }

            var r = /^\+?[1-9][0-9]*$/;　　//正整数正则
            if(! r.test(experience_value)){
                $("#question_message").text("经验值/分值请输入整数").css({color:"red"});
                return false;
            }

            var question = new Object();
            question.questionDescription = question_description;
            question.testPoint = test_point;
            question.choiceA = choice_a;
            question.choiceB = choice_b;
            question.choiceC = choice_c;
            question.choiceD = choice_d;
            question.choiceE = choice_e;
            question.correctOption = correct_option;
            question.answerAnalysis = answer_analysis;
            question.experienceValue = experience_value;
            question.lNo = lNo;

            var questionJson = JSON.stringify(question);

            $.ajax({
                url: "/question/addQuestion",
                dataType: "text",
                type: "post",
                data: {"question":questionJson},
                success: function (result) {
                    if(result == "true"){
                        closeAddQuestionPanel();
                        //刷新关卡详情页
                        findAllQuestionByLNo(currentLevel.lNo);
                    }
                },
                error: function (e) {
                    alert("错误")
                }
            });
        }

        function findAllQuestionByLNo(lNo){
            $.ajax({
                url: "/question/findAllQuestionByLNo",
                dataType: "text",
                type: "post",
                data: {"lNo":lNo},
                success: function (result) {
                    var maxw = document.documentElement.clientWidth;
                    var maxh = document.documentElement.clientHeight;
                    $("#level_info").css({"z-index":"90","backgroundColor":"white","position":"fixed",width:maxw+"px",height:maxh+"px","top":"50%","left":"50%","margin-left":(-maxw/2)+"px","margin-top":(-maxh/2)+"px"});
                    $("#level_info").show();
                    $("html").addClass("unfoces");
                    $("body").addClass("unfoces");
                    $("#add_question").addClass("unfoces");
                    $("#add_level").addClass("unfoces");
                    $("#level_title").text("关卡"+currentLevel.grade);
                    $("#level_grade").text(currentLevel.grade);
                    $("#level_description").text(currentLevel.description);
                    $("#level_experience_need").text(currentLevel.experienceNeed);
                    $("#level_rate").text(currentLevel.rate+"%");

                    $("#add_question_button").click({"lNo":lNo},showAddQuestion);
                   // alert(result)
                    if(result != ""){
                        loadQuestions($.parseJSON(result));
                    }
                },
                error: function (e) {
                    alert("错误")
                }
            });
        }

        function showAddLevel(){

            var maxw = document.documentElement.clientWidth;
            var maxh = document.documentElement.clientHeight;
            $("#add_level").css({"z-index":"90","backgroundColor":"white","position":"fixed",width:maxw+"px",height:maxh+"px","top":"50%","left":"50%","margin-left":(-maxw/2)+"px","margin-top":(-maxh/2)+"px"});
            $("#add_level").show();
            $("html").addClass("unfoces");
            $("body").addClass("unfoces");
            $("#level_info").addClass("unfoces");
            $("#add_question").addClass("unfoces");

            $("#grade").val(lastLevel.grade+1);
            $("#experience_need").attr("placeholder","应大于"+lastLevel.experienceNeed);
            //closeLevelInfoPanel();

        }


        function showAddQuestion(d){

            var lNo = d.data.lNo;
            var maxw = document.documentElement.clientWidth;
            var maxh = document.documentElement.clientHeight;
            $("#add_question").css({"z-index":"91","backgroundColor":"white","position":"fixed",width:maxw+"px",height:maxh+"px","top":"50%","left":"50%","margin-left":(-maxw/2)+"px","margin-top":(-maxh/2)+"px"});
            $("#add_question").show();
            $("html").addClass("unfoces");
            $("body").addClass("unfoces");
            $("#level_info").addClass("unfoces");
            $("#add_level").addClass("unfoces");

            $("#lNo").val(lNo);


        }
        function showLevelInfo(d){

            currentLevel = d.data.level;

            findAllQuestionByLNo(currentLevel.lNo);

        }

        function loadQuestions(questionList){

            var tbody = $("#question_list tbody");
            $(tbody).empty();
            for(var i = 0;i<questionList.length;i++) {
                var question = questionList[i];
                var tr = document.createElement("tr");
                var td_description = document.createElement("td");
                var td_test_point = document.createElement("td");
                var td_experience_value = document.createElement("td");

                var td_operation = document.createElement("td");
                var a_showInfo = document.createElement("a");
                $(a_showInfo).text("查看 ")
                var a_edit = document.createElement("a");
                $(a_edit).text("编辑 ")
                var a_delete = document.createElement("a");
                $(a_delete).text("删除 ")
                $(a_delete).click({"qNo":question.qNo},deleteQuestionFromLevel);
                $(td_operation).append(a_showInfo, a_edit, a_delete);

                $(tr).append(td_description, td_test_point, td_experience_value, td_operation);

                $(td_description).text(question.questionDescription)
                $(td_test_point).text(question.testPoint)
                $(td_experience_value).text(question.experienceValue)

                $(tbody).append(tr)
            }

        }

        function  deleteQuestionFromLevel(d) {
            var qNo = d.data.qNo;
            $.ajax({
                url: "/question/deleteQuestionFromLevel",
                dataType: "text",
                type: "post",
                data: {"qNo":qNo},
                success: function (result) {

                    if(result == "true"){
                        //重新加载题目列表
                        findAllQuestionByLNo(currentLevel.lNo);
                    }
                },
                error: function (e) {
                    alert("错误")
                }
            });

        }
        
        
        function closeAddLevelPanel(){
            $('#add_level').fadeOut(500);
            $("html").removeClass("unfoces");
            $("body").removeClass("unfoces");
            $("#add_question").removeClass("unfoces");
            $("#level_info").removeClass("unfoces");
        }
        function closeLevelInfoPanel(){
            $('#level_info').fadeOut(500);
            $("html").removeClass("unfoces");
            $("body").removeClass("unfoces");
            $("#add_question").removeClass("unfoces");
            $("#add_level").removeClass("unfoces");
        }
        function closeAddQuestionPanel(){
            $('#add_question').fadeOut(500);
            $("html").removeClass("unfoces");
            $("body").removeClass("unfoces");
            $("#add_level").removeClass("unfoces");
            $("#level_info").removeClass("unfoces");
        }

    </script>

    <style>
        div{
            border: 0px solid;
        }


    </style>


</head>
<body>
<div id="header">
    <script>$("#header").load("admin_nav.html")</script>
</div>

<div class="grid-container  fluid margin_top" >
    <div class="cell text-right" style="position: sticky;position: -webkit-sticky; top: 0px;">
        <button class="button dark"  id="add_level_button" onclick="showAddLevel()">添加关卡</button>
    </div>

    <div id="content" class="grid-x grid-margin-x grid-margin-y">
        <!--div1-->
        <div class="cell small-12 medium-4 large-3 padding_vertical" >
            <!--div2-->
            <div class="grid-padding-x content_center" style="box-shadow: 10px 10px 5px #888888; width: 150px;border-radius: 5px">
                <!--div3_img-->
                <div class="large-12 medium-12 content_center" style="overflow: hidden; background-color: #3adb76; height: 100px;">
                    <span style="padding: 0px auto">关卡1</span>
                </div>
                <!--div3_content-->
                <div class="large-12 medium-12 content_center" style="overflow: hidden; height: 50px;" >
                    关卡描述 关卡描述关卡描述 关卡描述关卡描述 关卡描述关卡描述 关卡描述关卡描述 关卡描述关卡描述 关卡描述
                </div>
            </div>
        </div>








    </div>
</div>




<div  id="level_info" style="position: fixed; display: none; padding: 1rem;overflow-y: auto;overflow-scrolling: inherit">
    <div class="text-right" style="position: sticky;position: -webkit-sticky; top: 0px;">
        <button class="button dark" data-open="comment_panel" id="add_question_button">添加选择题</button>
        <button onclick="closeLevelInfoPanel()" class="button success">关闭</button>
    </div>

    <h3 id="level_title" style="font-weight: bold"></h3>
    <div class="grid-padding-x">
        <div class="cell small-12 medium-4" id="level_info_content">
            <table>
                <tbody>
                    <tr>
                        <td>关卡等级:</td><td id="level_grade"></td>
                    </tr>
                    <tr>
                        <td>描述:</td><td id="level_description"></td>
                    </tr>
                    <tr>
                        <td>所需经验:</td><td id="level_experience_need"></td>
                    </tr>
                    <tr>
                        <td>通关率(单位：%):</td><td id="level_rate"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="cell small-12 medium-8" id="question_list">
            <div>
                <table>
                    <thead>
                        <th>
                            <td>问题描述</td><td>考点</td><td>经验值</td><td>操作</td>
                        </th>
                    </thead>
                    <tbody>
                    <tr>
                        <td></td><td></td><td></td><td><a>查看 </a><a>编辑 </a><a>删除</a></td>
                    </tr>

                    </tbody>
                </table>

            </div>
        </div>

    </div>
    <hr/>

</div>

<div id="add_level"  style="position: fixed; display: none; padding: 1rem;overflow-y: auto;overflow-scrolling: inherit">
    <div class="content_center grid-container" >
        <div class="text-right" style="position: sticky;position: -webkit-sticky; top: 0px;">
            <button onclick="closeAddLevelPanel()" class="button success">关闭</button>
        </div>
        <h1>添加关卡</h1>
        <label for="grade">关卡等级
            <input type="text" placeholder="grade" readonly id="grade" >
        </label>
        <label for="experience_need">所需经验
            <input type="text" placeholder="解锁关卡所需要的经验值" id="experience_need">
        </label>
        <label for="description">描述
            <input type="text" placeholder="关卡描述" id="description">
        </label>
        <label for="rate">通关率
            <input type="text" placeholder="通关率应在0到100之间" id="rate">
        </label>
        <button onclick="addLevel()" class="button success">添加</button><span id="level_message"></span>
    </div>
</div>





<div  id="add_question" style="position: fixed; display: none; padding: 1rem;overflow-y: auto;overflow-scrolling: inherit">

    <div class="content_center grid-container">
        <h1>添加选择题</h1>
        <div class="text-right" style="position: sticky;position: -webkit-sticky; top: 0px;">
            <button onclick="closeAddQuestionPanel()" class="button success">关闭</button>
        </div>
        <input type="hidden" id="lNo" >
        <label for="question_description">问题描述
            <input type="text" placeholder="描述一下问题" id="question_description" >
        </label>
        <label for="test_point">考点
            <input type="text" placeholder="考点" id="test_point" >
        </label>
        <label for="choice_a">A选项
            <input type="text" placeholder="A选项" id="choice_a">
        </label>
        <label for="choice_b">B选项
            <input type="text" placeholder="B选项" id="choice_b">
        </label>
        <label for="choice_c">C选项
            <input type="text" placeholder="C选项" id="choice_c">
        </label>
        <label for="choice_d">D选项
            <input type="text" placeholder="D选项" id="choice_d">
        </label>
        <label for="choice_e">E选项
            <input type="text" placeholder="E选项" id="choice_e">
        </label>
        <label for="correct_option">正确选项
            <input type="text" placeholder="正确选项" id="correct_option">
        </label>
        <label for="answer_analysis">答案解析
            <input type="text" placeholder="答案解析" id="answer_analysis">
        </label>
        <label for="experience_value">分值/经验值
            <input type="text" placeholder="分值/经验值" id="experience_value">
        </label>
        <button onclick="addQuestion()" class="button success">添加</button><span id="question_message"></span>

    </div>
</div>



</body>
</html>


<script src="js/vendor/what-input.js"></script>
<script src="js/vendor/foundation.js"></script>
<script src="js/app.js"></script>